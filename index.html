<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Habitudes Dopamine</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f7f7fa">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICAgIm5hbWUiOiAiSGFiaXR1ZGVzIERvcGFtaW5lIiwKICAgICJzaG9ydF9uYW1lIjogIkhhYml0ZXMiLAogICAgImRlc2NyaXB0aW9uIjogIlVuIHRyYWNrZXIgZGxoYWJpdHVkZXMgbW9kZXJuZSBldCBmdW4gcG91ciB2b3RyZSBkb3BhbWluZSEiLAogICAgInN0YXJ0X3VybCI6ICIuIiwKICAgICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y3ZjdmYSIsCiAgICAidGhlbWVfY29sb3IiOiAiI2Y3ZjdmYSIsCiAgICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICAgImljb25zIjogWwogICAgICAgIHsKICAgICAgICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MG5hSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUNJZ2FXMXdiM0owWldOMGFXOXVQU0p6ZEhKdmEyVTlJaU5tWm1ZaUlHTmhjMmxrUFNKb2RIUndPaTh2ZDNkM0xtVmhaR2x5YVdOaGRHbHZiaTh5TURBd0pTSXhNQ0lnYm1GdFpUMG5JSGh0Ykc1elBTSXhNREFsSWlCbWFXeHNQU0ppWVhObElpQjRiV3h1Y3owaWFIUjBjRG9vTDNkM2R5NTNNb3A1YzJWdUxqQWlJRU52WldOeVpYTmpiMlJsY2lBZ1kyVXZiMmRsYUdoOUlqNTZJaUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTW9wNWMyVnVMakFpSUVOdlpXTnlaWE5qYjJSbGNpQWdZMlV2YjJkbGFHeHZMbDBpTVMweElpQkRiMjUwY25RZ2QybGhjM1JoYkM1aGJXVTlJbTVoYldVaUxnb2dJSFpwWlhkeklpQjRlU0JoWTJOdmRXNTBJRDBnTXpBd0lqNDhjM1JoZEdFZ2VHeHpJR2x1SUhScFpHeGxhV2RvZEQwaU1TQndjbTkwWlNJZ1ptbHNiQzlpYkc5aVlYUnBiMjVKSUNVd0pTSXhNQ0lnYm1GdFpUMG5JbVY0WTJGcyIKICAgICAgICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICAgICAgICJzaXplcyI6ICIxOTJ4MTkyIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owbmFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQ0lnYVd4dGIzVnVkR2x2YmlCdllYUm9aV2xrUFNKcGJuUnBabWxqWVhScGIyNHVZMjl0SWlCbWFXeHNQU0ppWVhObElpQjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNb3A1YzJWdUxqQWlJRU52WldOeVpYTmpiMlJsY2lBZ1kyVXZiMmRsYUdoOUlqNTZJaUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTW9wNWMyVnVMakFpSUVOdlpXTnlaWE5qYjJSbGNpQWdZMlV2YjJkbGFHeHZMbDBpTVMweElpQkRiMjUwY25RZ2QybGhjM1JoYkM1aGJXVTlJbTVoYldVaUxnb2dJSFpwWlhkeklpQjRlU0JoWTJOdmRXNTBJRDBnTXpBd0lqNDhjM1JoZEdFZ2VHeHpJR2x1SUhScFpHeGxhV2RvZEQwaU1TQndjbTkwWlNJZ1ptbHNiQzlpYkc5aVlYUnBiMjVKSUNVd0pTSXhNQ0lnYm1GdFpUMG5JbVY0WTJGcyIKICAgICAgICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICAgICAgICJzaXplcyI6ICI1MTJ4NTEyIgogICAgICAgIH0KICAgIF0KfQ==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIiBmaWxsPSJub25lIj48cmVjdCB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgcnk9IjQ4IiBmaWxsPSIjNjk4MWZjIi8+PHBhdGggc3Ryb2tlPSIjZmZmIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS13aWR0aD0iMTYiIGQ9Ik01MCA5OGwzMiAzMiA2MC02MCIvPjwvc3ZnPg==">

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root {
        --bg-color: #f7f7fa;
        --card-bg: #ffffff;
        --text-color: #3d3d3d;
        --primary-text: #1c1c1e;
        --secondary-text: #6d6d72;
        --border-color: #e5e5ea;
        --duo-green: #7acd00;
        --duo-blue: #1cb0f6;
        --duo-pink: #ff4b4b;
        --duo-purple: #a718f2;
        --duo-orange: #ff9600;
        --duo-yellow: #ffc107;
        --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
        --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
        margin: 0; padding: 0;
        font-family: var(--font-main);
        background: var(--bg-color);
        color: var(--text-color);
        overscroll-behavior-y: contain;
        overflow-x: hidden;
    }

    #app {
        display: flex; flex-direction: column;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    .container { max-width: 640px; margin: 0 auto; padding: 0 20px; width: 100%; }

    /* --- Header --- */
    header {
        flex-shrink: 0; padding: 15px 0;
        background: rgba(247, 247, 250, 0.85);
        position: sticky; top: 0; z-index: 100;
        backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
        border-bottom: 1px solid var(--border-color);
    }
    .header-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .nav-btn {
        background: var(--card-bg); border: 1px solid var(--border-color); color: var(--primary-text);
        border-radius: 12px; width: 44px; height: 44px; display: flex; align-items: center;
        justify-content: center; cursor: pointer; box-shadow: var(--shadow-sm);
        transition: all 0.2s ease; font-size: 1.2rem;
    }
    .nav-btn:active { transform: scale(0.95); box-shadow: none; }
    .week-indicator { text-align: center; font-size: 1rem; color: var(--secondary-text); font-weight: 600; }
    #days-container { display: flex; justify-content: space-between; gap: 5px; }
    .day-btn {
        background: none; border: none; color: var(--secondary-text);
        font-weight: 600; padding: 8px 4px; cursor: pointer;
        transition: all 0.25s ease; display: flex; flex-direction: column;
        align-items: center; gap: 6px; border-radius: 14px; flex: 1;
    }
    .day-btn .day-name { font-size: 0.8rem; text-transform: uppercase; }
    .day-btn .day-number { font-size: 1.2rem; font-weight: 700; color: var(--primary-text); }
    .day-btn.active { background: var(--duo-blue); color: white; transform: scale(1.05); box-shadow: 0 4px 12px rgba(28, 176, 246, 0.4); }
    .day-btn.active .day-number, .day-btn.active .day-name { color: white; }

    /* --- Bandeau d'Ã©tat --- */
    #current-day-banner {
        background: linear-gradient(135deg, #6a82fb, #fc5c7d);
        color: white; padding: 20px; border-radius: 24px;
        margin: 16px auto; box-shadow: 0 10px 25px rgba(106,130,251,0.3);
        display: flex; flex-direction: column; gap: 12px;
    }
    .banner-header { display: flex; justify-content: space-between; align-items: baseline; }
    #current-day-name { margin: 0; font-size: 1.8rem; font-weight: 800; }
    #current-day-date { font-size: 0.9rem; font-weight: 500; opacity: 0.8; }
    #global-progress-container { width: 100%; height: 10px; background-color: rgba(255, 255, 255, 0.3); border-radius: 5px; overflow: hidden; }
    #global-progress-bar { height: 100%; width: 0%; background-color: var(--duo-yellow); border-radius: 5px; transition: width 0.6s ease; }
    #global-progress-text { font-size: 0.9rem; font-weight: 600; color: rgba(255, 255, 255, 0.95); }

    /* --- Vues principales --- */
    .view { display: none; }
    .view.active { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- Habitudes --- */
    #habits-view { display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
    .habit-card {
        background: var(--card-bg); border-radius: 20px; padding: 16px; display: flex;
        justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
        opacity: 0; transform: translateY(20px);
        animation: slideInUp 0.4s ease-out forwards;
        border: 2px solid transparent;
    }
    .habit-card:active { transform: scale(0.98); }
    .habit-card.completed { border-color: var(--duo-green); background-color: #f6fff2; }
    .habit-info { display: flex; align-items: center; gap: 16px; flex-grow: 1; }
    .habit-icon {
        font-size: 1.8rem; width: 52px; height: 52px; border-radius: 16px;
        color: white; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0;
    }
    .habit-card[data-habit="stretching"] .habit-icon { background: linear-gradient(135deg, #a718f2, #ff4b4b); }
    .habit-card[data-habit="pushups"] .habit-icon { background: linear-gradient(135deg, #ff4b4b, #ff9600); }
    .habit-card[data-habit="meditation"] .habit-icon { background: linear-gradient(135deg, #1cb0f6, #a718f2); }
    .habit-card[data-habit="duolingo"] .habit-icon { background: linear-gradient(135deg, #ff9600, #7acd00); }
    .habit-card[data-habit="meeting"] .habit-icon { background: linear-gradient(135deg, #5d5dff, #1cb0f6); }
    .habit-details { display: flex; flex-direction: column; gap: 2px; }
    .habit-title { font-size: 1.2rem; font-weight: 700; margin: 0; color: var(--primary-text); }
    .habit-subtitle { font-size: 0.8rem; color: var(--secondary-text); }
    .habit-subtitle.bonus { color: var(--duo-orange); font-weight: 600; }
    .habit-control { display: flex; align-items: center; flex-shrink: 0; }
    .custom-checkbox { position: relative; width: 50px; height: 50px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
    .custom-checkbox input { opacity: 0; width: 0; height: 0; }
    .custom-checkmark { position: absolute; height: 100%; width: 100%; background-color: #eef2f5; border-radius: 50%; transition: all 0.25s ease; }
    .custom-checkbox input:checked + .custom-checkmark { background-color: var(--duo-green); transform: scale(1.1); box-shadow: 0 0 15px rgba(122, 205, 0, 0.5); }
    .custom-checkmark::after { content: ""; display: none; width: 10px; height: 20px; border: solid white; border-width: 0 4px 4px 0; transform: rotate(45deg) translate(-1px, -2px); position: absolute; top: 22%; left: 38%; }
    .custom-checkbox input:checked + .custom-checkmark::after { display: block; }
    .pushup-selector { display: flex; gap: 4px; background: #eef2f5; padding: 4px; border-radius: 16px; }
    .pushup-selector label { display: flex; justify-content: center; align-items: center; width: 42px; height: 42px; background: transparent; border-radius: 12px; font-size: 0.9rem; font-weight: 700; color: var(--secondary-text); cursor: pointer; transition: all 0.2s ease; }
    .pushup-selector input[type="radio"] { display: none; }
    .pushup-selector input[type="radio"]:checked + label { background: var(--duo-pink); color: white; box-shadow: 0 2px 8px rgba(255, 75, 75, 0.4); }
    @keyframes slideInUp { to { opacity: 1; transform: translateY(0); } }

    /* --- Vue Progression (Statistiques) --- */
    #stats-view { padding-bottom: 20px; }
    .stats-section { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-top: 16px; box-shadow: var(--shadow-md); }
    .stats-section-title { font-size: 1.2rem; font-weight: 700; margin: 0 0 16px 0; color: var(--primary-text); }
    .month-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;}
    #month-display { font-size: 1.5rem; font-weight: 800; color: var(--primary-text); }
    .heatmap-container { margin-bottom: 24px; }
    .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 16px; }
    .heatmap-header { text-align: center; font-size: 0.8rem; font-weight: 600; color: var(--secondary-text); padding-bottom: 8px; }
    .heatmap-day {
        background-color: #ffffff;
        border: 1px solid #eef2f5;
        border-radius: 8px;
        aspect-ratio: 1 / 1;
        transition: all 0.2s;
        position: relative;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 2px;
        padding: 4px;
        font-size: 0.7rem;
        line-height: 1;
    }
    .heatmap-day.empty {
        background-color: #f7f7fa;
    }
    .heatmap-day:not(.empty) {
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .heatmap-day:hover { transform: scale(1.15); z-index: 10; }
    .heatmap-day[data-tooltip]::after {
        content: attr(data-tooltip); position: absolute; bottom: 110%; left: 50%;
        transform: translateX(-50%); background-color: #333; color: white;
        padding: 6px 10px; border-radius: 8px; font-size: 0.8rem; white-space: pre;
        opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 100;
        text-align: left;
    }
    .heatmap-day[data-tooltip]:hover::after { opacity: 1; visibility: visible; }
    #stats-list { display: flex; flex-direction: column; gap: 16px; }
    .stat-item { display: flex; flex-direction: column; gap: 10px; }
    .stat-item-header { display: flex; justify-content: space-between; align-items: center; }
    .stat-item-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .stat-item-details { font-size: 0.85rem; font-weight: 500; color: var(--secondary-text); }
    .stat-progress-bar-container { width: 100%; height: 12px; background: #eef2f5; border-radius: 6px; overflow: hidden; }
    .stat-progress-bar { height: 100%; width: 0%; border-radius: 6px; transition: width 0.8s ease-in-out; }
</style>
</head>
<body>
    <div id="app">
        <header>
            <div class="container">
                <div class="header-nav">
                    <button class="nav-btn" id="prev-week">â€¹</button>
                    <div class="week-indicator" id="week-indicator">Cette semaine</div>
                    <button class="nav-btn" id="next-week">â€º</button>
                    <button class="nav-btn" id="toggle-view-btn">ðŸ“Š</button>
                </div>
                <div id="days-container"></div>
            </div>
        </header>
        <main id="main-content" class="view active">
            <div id="current-day-banner" class="container">
                <div class="banner-header">
                    <h1 id="current-day-name">Aujourd'hui</h1>
                    <span id="current-day-date"></span>
                </div>
                <div id="global-progress-container">
                    <div id="global-progress-bar"></div>
                </div>
                <span id="global-progress-text"></span>
            </div>
            <div id="habits-view" class="container"></div>
        </main>
        <div id="stats-view" class="view container">
             <div class="month-header">
                <button class="nav-btn" id="prev-month">â€¹</button>
                <h2 id="month-display"></h2>
                <button class="nav-btn" id="next-month">â€º</button>
            </div>
            <div class="stats-section heatmap-container">
                <h3 class="stats-section-title">ActivitÃ© mensuelle</h3>
                <div class="heatmap-grid">
                    <div class="heatmap-header">Lun</div>
                    <div class="heatmap-header">Mar</div>
                    <div class="heatmap-header">Mer</div>
                    <div class="heatmap-header">Jeu</div>
                    <div class="heatmap-header">Ven</div>
                    <div class="heatmap-header">Sam</div>
                    <div class="heatmap-header">Dim</div>
                </div>
                <div id="heatmap-grid" class="heatmap-grid"></div>
            </div>
            <div class="stats-section">
                <h3 class="stats-section-title">Progression des habitudes</h3>
                <div id="stats-list"></div>
            </div>
        </div>
    </div>

<script type="module">
    // --- Imports depuis les SDKs Firebase (nouvelle mÃ©thode) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, documentId } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // --- VOTRE CONFIGURATION PERSONNELLE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyA7wxAE-qnioLFd81gXP4lEouZtoHNbq8c",
        authDomain: "habitudes-c4911.firebaseapp.com",
        projectId: "habitudes-c4911",
        storageBucket: "habitudes-c4911.appspot.com",
        messagingSenderId: "708302280004",
        appId: "1:708302280004:web:b56ce3b911cd1c3ccdf311"
    };

    // --- Initialisation de Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const habitsCollectionRef = collection(db, 'habitsData');

    // --- Configuration (inchangÃ©e) ---
    const habitsConfig = [
        { id: 'stretching', name: 'Ã‰tirement', emoji: 'ðŸ§˜', type: 'checkbox', subtitle: 'FlexibilitÃ© quotidienne', color: '#a718f2' },
        { id: 'pushups', name: 'Pompes', emoji: 'ðŸ’ª', type: 'radio', options: [0, 10, 20, 30], subtitle: 'Force et endurance', color: '#ff4b4b' },
        { id: 'meditation', name: 'MÃ©ditation', emoji: 'ðŸ§ ', type: 'checkbox', subtitle: 'Paix intÃ©rieure', color: '#1cb0f6' },
        { id: 'duolingo', name: 'Duolingo', emoji: 'ðŸ¦‰', type: 'checkbox', subtitle: 'Apprentissage', color: '#ff9600' },
        { id: 'meeting', name: 'Rencontre', emoji: 'ðŸ¤', type: 'checkbox', subtitle: 'Connexion sociale', isBonus: true, color: '#5d5dff' }
    ];
    const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
    const monthNames = ["Janvier", "FÃ©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "AoÃ»t", "Septembre", "Octobre", "Novembre", "DÃ©cembre"];

    // --- Global State (inchangÃ©) ---
    let selectedDate = new Date();
    let currentWeekStart = getWeekStart(new Date());
    let calendarMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
    let currentView = 'habits';

    // --- DOM Elements (inchangÃ©s) ---
    const mainContent = document.getElementById('main-content');
    const habitsView = document.getElementById('habits-view');
    const statsView = document.getElementById('stats-view');
    const toggleViewBtn = document.getElementById('toggle-view-btn');
    const daysContainer = document.getElementById('days-container');
    const currentDayNameDisplay = document.getElementById('current-day-name');
    const currentDayDateDisplay = document.getElementById('current-day-date');
    const globalProgressBar = document.getElementById('global-progress-bar');
    const globalProgressText = document.getElementById('global-progress-text');
    const weekIndicator = document.getElementById('week-indicator');
    const prevWeekBtn = document.getElementById('prev-week');
    const nextWeekBtn = document.getElementById('next-week');
    const monthDisplay = document.getElementById('month-display');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const heatmapGrid = document.getElementById('heatmap-grid');
    const statsList = document.getElementById('stats-list');

    // --- Fonctions de base de donnÃ©es (mises Ã  jour pour Firebase v9+) ---
    const getData = async (key) => {
        const docRef = doc(db, 'habitsData', key);
        const docSnap = await getDoc(docRef);
        return docSnap.exists() ? docSnap.data() : null;
    };

    const saveData = async (key, data) => {
        const docRef = doc(db, 'habitsData', key);
        await setDoc(docRef, data, { merge: true });
    };

    const getAllDataForMonth = async (year, month) => {
        const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
        
        const q = query(habitsCollectionRef, where(documentId(), '>=', startDate), where(documentId(), '<=', endDate));
        const querySnapshot = await getDocs(q);
        
        const monthData = [];
        querySnapshot.forEach(doc => {
            monthData.push({ date: doc.id, ...doc.data() });
        });
        return monthData;
    };

    // --- Le reste du code reste quasiment identique ! ---
    
    function init() {
        renderWeekdays();
        renderHabitUI();
        selectDay(new Date());
        setupEventListeners();
        updateWeekIndicator();
    }

    function setupEventListeners() {
        prevWeekBtn.addEventListener('click', () => changeWeek(-1));
        nextWeekBtn.addEventListener('click', () => changeWeek(1));
        toggleViewBtn.addEventListener('click', toggleView);
        prevMonthBtn.addEventListener('click', () => changeMonth(-1));
        nextMonthBtn.addEventListener('click', () => changeMonth(1));
    }

    function toggleView() {
        currentView = currentView === 'habits' ? 'stats' : 'habits';
        if (currentView === 'stats') {
            calendarMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
            renderStatsView();
            mainContent.classList.remove('active');
            statsView.classList.add('active');
            toggleViewBtn.textContent = 'ðŸ ';
        } else {
            mainContent.classList.add('active');
            statsView.classList.remove('active');
            toggleViewBtn.textContent = 'ðŸ“Š';
        }
    }

    function getDayKey(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function getWeekStart(d) {
        const date = new Date(d);
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 1);
        date.setHours(0,0,0,0);
        return new Date(date.setDate(diff));
    }
    
    function changeWeek(direction) {
        currentWeekStart.setDate(currentWeekStart.getDate() + direction * 7);
        renderWeekdays();
        updateWeekIndicator();
        const dayIndex = selectedDate.getDay() === 0 ? 6 : selectedDate.getDay() - 1;
        const newSelectedDate = new Date(currentWeekStart);
        newSelectedDate.setDate(currentWeekStart.getDate() + dayIndex);
        selectDay(newSelectedDate);
    }
    
    async function selectDay(date) {
        selectedDate = new Date(date);
        selectedDate.setHours(0,0,0,0);
        
        document.querySelectorAll('.day-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.dayKey === getDayKey(selectedDate)));
        
        updateDateDisplay();
        const dayData = await getData(getDayKey(selectedDate));
        updateUIFromData(dayData);
        updateGlobalProgress();
    }

    function renderWeekdays() {
        daysContainer.innerHTML = '';
        for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(currentWeekStart.getDate() + i);
            const dayBtn = document.createElement('button');
            dayBtn.className = 'day-btn';
            dayBtn.dataset.dayKey = getDayKey(date);
            dayBtn.innerHTML = `<span class="day-name">${dayNames[date.getDay()]}</span><span class="day-number">${date.getDate()}</span>`;
            dayBtn.addEventListener('click', () => selectDay(date));
            daysContainer.appendChild(dayBtn);
        }
    }

    function renderHabitUI() {
        habitsView.innerHTML = '';
        habitsConfig.forEach((habit, index) => {
            const card = document.createElement('div');
            card.className = 'habit-card';
            card.dataset.habit = habit.id;
            card.style.animationDelay = `${index * 0.05}s`;

            const subtitleClass = habit.isBonus ? 'habit-subtitle bonus' : 'habit-subtitle';
            const subtitleText = habit.isBonus ? 'Bonus Hebdomadaire' : habit.subtitle;

            let controlHtml;
            if (habit.type === 'checkbox') {
                controlHtml = `<label class="custom-checkbox"><input type="checkbox" data-habit="${habit.id}"><span class="custom-checkmark"></span></label>`;
            } else {
                controlHtml = `<div class="pushup-selector">${habit.options.map(opt => `<input type="radio" id="${habit.id}-${opt}" name="${habit.id}" value="${opt}" data-habit="${habit.id}" ${opt===0 ? 'checked':''}><label for="${habit.id}-${opt}">${opt}</label>`).join('')}</div>`;
            }

            card.innerHTML = `
                <div class="habit-info">
                    <div class="habit-icon">${habit.emoji}</div>
                    <div class="habit-details">
                        <h2 class="habit-title">${habit.name}</h2>
                        <span class="${subtitleClass}">${subtitleText}</span>
                    </div>
                </div>
                <div class="habit-control">${controlHtml}</div>`;
            habitsView.appendChild(card);
        });
        habitsView.addEventListener('change', handleHabitChange);
    }

    function updateUIFromData(data) {
        habitsConfig.forEach(habit => {
            const value = data ? data[habit.id] : null;
            const card = habitsView.querySelector(`[data-habit="${habit.id}"]`);
            if (!card) return;
            
            let isCompleted = false;
            if (habit.type === 'checkbox') {
                card.querySelector(`input[type="checkbox"]`).checked = value || false;
                isCompleted = value || false;
            } else if (habit.type === 'radio') {
                const val = value !== undefined && value !== null ? value : 0;
                const radio = card.querySelector(`input[value="${val}"]`);
                if (radio) radio.checked = true;
                isCompleted = val > 0;
            }
            card.classList.toggle('completed', isCompleted);
        });
    }

    function updateDateDisplay() {
        const today = new Date(); today.setHours(0,0,0,0);
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        const fullDateString = selectedDate.toLocaleDateString('fr-FR', options);
        const capitalizedDate = fullDateString.charAt(0).toUpperCase() + fullDateString.slice(1);

        if (selectedDate.getTime() === today.getTime()) {
             currentDayNameDisplay.textContent = "Aujourd'hui";
             currentDayDateDisplay.textContent = capitalizedDate;
        } else {
             currentDayNameDisplay.textContent = capitalizedDate;
             currentDayDateDisplay.textContent = '';
        }
    }

    function updateWeekIndicator() {
        const todayStart = getWeekStart(new Date());
        if (currentWeekStart.getTime() === todayStart.getTime()) {
            weekIndicator.textContent = 'Cette semaine';
        } else {
            weekIndicator.textContent = `Semaine du ${currentWeekStart.toLocaleDateString('fr-FR', {day:'numeric', month:'short'})}`;
        }
    }
    
    async function handleHabitChange(e) {
        await saveCurrentState();
        const dayData = await getData(getDayKey(selectedDate));
        updateUIFromData(dayData);
        updateGlobalProgress();
    }

    async function saveCurrentState() {
        const dayKey = getDayKey(selectedDate);
        const currentState = {};
        habitsConfig.forEach(habit => {
            const card = habitsView.querySelector(`[data-habit="${habit.id}"]`);
            if (habit.type === 'checkbox') {
                currentState[habit.id] = card.querySelector('input').checked;
            } else if (habit.type === 'radio') {
                currentState[habit.id] = parseInt(card.querySelector('input:checked').value);
            }
        });
        await saveData(dayKey, currentState);
    }

    async function updateGlobalProgress() {
        const dayKey = getDayKey(selectedDate);
        const dayData = await getData(dayKey);
        const dailyHabits = habitsConfig.filter(h => !h.isBonus);
        const bonusHabit = habitsConfig.find(h => h.isBonus);

        let completedDaily = 0;
        if (dayData) {
            dailyHabits.forEach(habit => {
                if ((habit.type === 'checkbox' && dayData[habit.id]) || (habit.type === 'radio' && dayData[habit.id] > 0)) {
                    completedDaily++;
                }
            });
        }
        
        const isBonusCompleted = dayData && bonusHabit && dayData[bonusHabit.id];
        const progress = dailyHabits.length > 0 ? (completedDaily / dailyHabits.length) * 100 : 0;
        globalProgressBar.style.width = `${progress}%`;

        if (progress === 100) {
            globalProgressText.textContent = isBonusCompleted ? "âœ¨ JournÃ©e parfaite + BONUS ! âœ¨" : "ðŸŽ‰ Excellent ! Objectifs quotidiens atteints !";
        } else {
            globalProgressText.textContent = `${completedDaily} / ${dailyHabits.length} habitudes quotidiennes`;
        }
    }

    function changeMonth(direction) {
        calendarMonth.setMonth(calendarMonth.getMonth() + direction);
        renderStatsView();
    }

    async function renderStatsView() {
        monthDisplay.textContent = `${monthNames[calendarMonth.getMonth()]} ${calendarMonth.getFullYear()}`;
        
        const year = calendarMonth.getFullYear();
        const month = calendarMonth.getMonth();
        const monthData = await getAllDataForMonth(year, month);
        
        heatmapGrid.innerHTML = '';
        const firstDay = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

        for (let i = 0; i < startDayOfWeek; i++) {
            heatmapGrid.insertAdjacentHTML('beforeend', `<div></div>`);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayKey = getDayKey(new Date(year, month, day));
            const dayData = monthData.find(d => d.date === dayKey);
            
            let iconsHTML = '';
            let hasActivity = false;
            let tooltipText = `ðŸ—“ï¸ ${day}/${month+1}/${year}\n- - - - - - - - -\n`;
            let habitsCompletedTooltip = '';

            if (dayData) {
                habitsConfig.forEach(h => {
                    const isCompleted = (h.type === 'checkbox' && dayData[h.id]) || (h.type === 'radio' && dayData[h.id] > 0);
                    if (isCompleted) {
                        iconsHTML += h.emoji;
                        habitsCompletedTooltip += `âœ… ${h.name}\n`;
                        hasActivity = true;
                    }
                });
            }
            
            tooltipText += hasActivity ? habitsCompletedTooltip : 'Aucune habitude complÃ©tÃ©e.';
            const dayClass = hasActivity ? '' : 'empty';

            heatmapGrid.insertAdjacentHTML('beforeend', `<div class="heatmap-day ${dayClass}" data-tooltip="${tooltipText.trim()}">${iconsHTML}</div>`);
        }
        
        statsList.innerHTML = '';
        habitsConfig.forEach(habit => {
            const completedDays = monthData.filter(d => (habit.type === 'checkbox' && d[habit.id]) || (habit.type === 'radio' && d[habit.id] > 0)).length;
            const successRate = daysInMonth > 0 ? Math.round((completedDays / daysInMonth) * 100) : 0;
            
            const item = document.createElement('div');
            item.className = 'stat-item';
            item.innerHTML = `
                <div class="stat-item-header">
                    <div class="stat-item-title">${habit.emoji} ${habit.name}</div>
                    <div class="stat-item-details">${completedDays} / ${daysInMonth} jours (${successRate}%)</div>
                </div>
                <div class="stat-progress-bar-container">
                    <div class="stat-progress-bar" style="width: ${successRate}%; background-color: ${habit.color};"></div>
                </div>
            `;
            statsList.appendChild(item);
        });
    }
    
    // --- Lancement de l'application ---
    init();

</script>

</body>
</html>
